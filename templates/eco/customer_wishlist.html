{% extends 'eco/base_common.html' %}
{% load static %}

{% block title %}My Wishlist - BookBazar{% endblock %}

{% block extra_css %}
<style>
    .wishlist-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1rem;
        min-height: 80vh;
    }

    .wishlist-header {
        text-align: center;
        margin-bottom: 3rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border);
    }

    .wishlist-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .wishlist-subtitle {
        color: var(--gray);
        font-size: 1.1rem;
    }

    .wishlist-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .wishlist-empty {
        text-align: center;
        padding: 4rem 2rem;
        background: var(--card-bg);
        border-radius: 12px;
        border: 2px dashed var(--border);
    }

    .empty-icon {
        font-size: 4rem;
        color: var(--gray);
        margin-bottom: 1.5rem;
    }

    .empty-title {
        font-size: 1.5rem;
        color: var(--text-color);
        margin-bottom: 1rem;
    }

    .empty-text {
        color: var(--gray);
        margin-bottom: 2rem;
        line-height: 1.6;
    }

    .btn-browse-books {
        background: var(--primary);
        color: white;
        padding: 0.8rem 2rem;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-block;
    }

    .btn-browse-books:hover {
        background: var(--primary-light);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
    }

    /* Wishlist Card Styles */
    .wishlist-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .wishlist-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        border-color: var(--primary);
    }

    .wishlist-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .wishlist-card:hover::before {
        transform: scaleX(1);
    }

    .wishlist-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .wishlist-remove-btn {
        background: none;
        border: none;
        color: #ef4444;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .wishlist-remove-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        transform: scale(1.1);
    }

    .wishlist-book-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .wishlist-book-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }

    .wishlist-book-title a {
        color: inherit;
        text-decoration: none;
    }

    .wishlist-book-title a:hover {
        color: var(--primary);
    }

    .wishlist-book-author {
        color: var(--gray);
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .wishlist-book-price {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--secondary);
        margin-bottom: 1.5rem;
    }

    .wishlist-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-move-to-cart {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        flex: 1;
        transition: all 0.3s ease;
    }

    .btn-move-to-cart:hover {
        background: var(--primary-light);
        transform: translateY(-1px);
    }

    .btn-view-details {
        background: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border);
        padding: 0.6rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        text-decoration: none;
        text-align: center;
        transition: all 0.3s ease;
        flex: 1;
    }

    .btn-view-details:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* Stock Status */
    .stock-badge {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .in-stock {
        background: rgba(16, 185, 129, 0.1);
        color: var(--secondary);
        border: 1px solid var(--secondary);
    }

    .out-of-stock {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid #ef4444;
    }

    /* Loading States */
    .loading {
        opacity: 0.7;
        pointer-events: none;
    }

    /* Toast Notifications */
    .toast {
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        max-width: 300px;
    }

    .toast.show {
        transform: translateX(0);
    }

    .toast.success {
        background: var(--secondary);
    }

    .toast.error {
        background: #ef4444;
    }

    .toast.info {
        background: var(--primary);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .wishlist-container {
            padding: 1rem;
        }

        .wishlist-title {
            font-size: 2rem;
        }

        .wishlist-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .wishlist-actions {
            flex-direction: column;
        }

        .toast {
            right: 10px;
            left: 10px;
            max-width: none;
        }
    }

    @media (max-width: 480px) {
        .wishlist-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="wishlist-container">
    <!-- Header -->
    <div class="wishlist-header">
        <h1 class="wishlist-title">My Wishlist</h1>
        <p class="wishlist-subtitle">
            {% if object %}
                {{ object|length }} item{{ object|length|pluralize }} saved for later
            {% else %}
                Your personal reading wishlist
            {% endif %}
        </p>
    </div>

    <!-- Wishlist Items -->
    {% if object %}
    <div class="wishlist-grid" id="wishlistGrid">
        {% for item in object %}
        <div class="wishlist-card" data-item-id="{{ item.id }}">
            <div class="wishlist-card-header">
                <button class="wishlist-remove-btn" onclick="removeFromWishlist('{{ item.book.slug }}', this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>

            <img src="{{ item.book.cover_image.url }}" alt="{{ item.book.title }}" class="wishlist-book-image">
            
            <h3 class="wishlist-book-title">
                <a href="{% url 'eco:product-detail' item.book.slug %}">{{ item.book.title }}</a>
            </h3>
            
            <p class="wishlist-book-author">by {{ item.book.author }}</p>
            
            <div class="stock-badge {% if item.book.is_available and item.book.stock_quantity > 0 %}in-stock{% else %}out-of-stock{% endif %}">
                {% if item.book.is_available and item.book.stock_quantity > 0 %}
                    <i class="fas fa-check"></i> In Stock
                {% else %}
                    <i class="fas fa-times"></i> Out of Stock
                {% endif %}
            </div>
            
            <div class="wishlist-book-price">${{ item.book.price }}</div>
            
            <div class="wishlist-actions">
                <button class="btn-move-to-cart" 
                        onclick="moveToCart('{{ item.book.slug }}', this)"
                        {% if not item.book.is_available or item.book.stock_quantity == 0 %}disabled{% endif %}>
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
                <a href="{% url 'eco:product-detail' item.book.slug %}" class="btn-view-details">
                    <i class="fas fa-eye"></i> View Details
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty Wishlist State -->
    <div class="wishlist-empty">
        <div class="empty-icon">
            <i class="far fa-heart"></i>
        </div>
        <h3 class="empty-title">Your wishlist is empty</h3>
        <p class="empty-text">
            Start building your reading list! Save books you're interested in 
            by clicking the heart icon on any book page.
        </p>
        <a href="{% url 'eco:product-list' %}" class="btn-browse-books">
            <i class="fas fa-book"></i> Browse Books
        </a>
    </div>
    {% endif %}
</div>

<!-- Toast Container -->
<div id="toastContainer"></div>
{% include 'eco/footer.html' %}
{% endblock %}

{% block extra_js %}
<script>
    class WishlistManager {
        constructor() {
            this.init();
        }

        init() {
            this.bindEvents();
        }

        bindEvents() {
            // Any additional event bindings can go here
        }

        async removeFromWishlist(bookSlug, button) {
            const card = button.closest('.wishlist-card');
            card.classList.add('loading');

            try {
                const response = await fetch(`/remove-from-wish/${bookSlug}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Remove card with animation
                    card.style.transform = 'scale(0.8)';
                    card.style.opacity = '0';
                    
                    setTimeout(() => {
                        card.remove();
                        this.updateWishlistCount();
                        this.showToast('Book removed from wishlist', 'info');
                        
                        // Check if wishlist is now empty
                        if (document.querySelectorAll('.wishlist-card').length === 0) {
                            this.showEmptyState();
                        }
                    }, 300);
                } else {
                    throw new Error(data.message || 'Failed to remove from wishlist');
                }
            } catch (error) {
                console.error('Error removing from wishlist:', error);
                this.showToast('Failed to remove from wishlist', 'error');
                card.classList.remove('loading');
            }
        }

        async moveToCart(bookSlug, button) {
            button.classList.add('loading');
            button.disabled = true;

            try {
                const response = await fetch(`/cart/add/${bookSlug}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        quantity: 1
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.showToast('Book added to cart!', 'success');
                    this.updateCartCount(data.total_items);
                } else {
                    throw new Error(data.message || 'Failed to add to cart');
                }
            } catch (error) {
                console.error('Error adding to cart:', error);
                this.showToast('Failed to add to cart', 'error');
            } finally {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        updateWishlistCount() {
            // Update wishlist count in navbar if you have one
            const wishlistCountElements = document.querySelectorAll('.wishlist-count');
            const currentCount = document.querySelectorAll('.wishlist-card').length;
            wishlistCountElements.forEach(element => {
                element.textContent = currentCount;
            });
        }

        updateCartCount(count) {
            const cartCountElements = document.querySelectorAll('.cart-count');
            cartCountElements.forEach(element => {
                element.textContent = count;
                element.style.transform = 'scale(1.3)';
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 300);
            });
        }

        showEmptyState() {
            const wishlistGrid = document.getElementById('wishlistGrid');
            if (wishlistGrid) {
                wishlistGrid.innerHTML = `
                    <div class="wishlist-empty" style="grid-column: 1 / -1;">
                        <div class="empty-icon">
                            <i class="far fa-heart"></i>
                        </div>
                        <h3 class="empty-title">Your wishlist is empty</h3>
                        <p class="empty-text">
                            Start building your reading list! Save books you're interested in 
                            by clicking the heart icon on any book page.
                        </p>
                        <a href="{% url 'eco:product-list' %}" class="btn-browse-books">
                            <i class="fas fa-book"></i> Browse Books
                        </a>
                    </div>
                `;
            }
        }

        showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove toast after duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }
    }

    // Global functions for onclick handlers
    function removeFromWishlist(bookSlug, button) {
        window.wishlistManager.removeFromWishlist(bookSlug, button);
    }

    function moveToCart(bookSlug, button) {
        window.wishlistManager.moveToCart(bookSlug, button);
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        window.wishlistManager = new WishlistManager();
        
        // Add animation to cards on load
        const cards = document.querySelectorAll('.wishlist-card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });
</script>
{% endblock %}